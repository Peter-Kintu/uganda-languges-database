{% extends "base.html" %}

{% block title %}Africana AI - Personalized Guidance{% endblock %}

{% block content %}
<style>
    /* --- CORE STYLING --- */
    body {
        background-color: #0a0e16;
        font-family: 'Inter', sans-serif;
        color: #e5e7eb;
        height: 100vh;
        margin: 0;
    }

    /* --- MAIN LAYOUT CONTAINER --- */
    .app-container {
        display: flex;
        height: 100vh;
        max-width: 100vw;
    }

    /* --- SIDEBAR STYLING --- */
    .sidebar {
        flex-shrink: 0;
        width: 320px;
        background-color: #111827;
        border-right: 1px solid #1f2937;
        display: flex;
        flex-direction: column;
        padding: 1.5rem 1rem;
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s ease;
        z-index: 40;
    }

    .sidebar.is-collapsed {
        width: 80px;
        padding: 1.5rem 0.75rem;
    }
    
    .sidebar.is-collapsed .sidebar-header h2,
    .sidebar.is-collapsed .history-item span, 
    .sidebar.is-collapsed .sidebar-footer #localTimeDisplay,
    .sidebar.is-collapsed .sidebar-footer #userLocationDisplay {
        display: none;
    }

    .sidebar.is-collapsed .sidebar-header {
        justify-content: center;
    }
    
    .sidebar.is-collapsed .utility-button-group {
        flex-direction: column;
        gap: 1.25rem;
        align-items: center;
    }
    
    .sidebar.is-collapsed .history-item {
        justify-content: center;
        padding: 0.75rem 0;
    }

    .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #1f2937;
    }
    
    .sidebar-header h2 {
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 700;
        color: #9ca3af;
    }

    .history-list {
        flex-grow: 1;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .history-item {
        display: flex;
        align-items: center;
        padding: 0.85rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 0.75rem;
        color: #9ca3af;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
        border: 1px solid transparent;
    }

    .history-item:hover {
        background-color: #1f2937;
        color: #ffffff;
    }
    
    .history-item.active {
        background-color: #3730a3;
        color: #ffffff;
        border-color: #4f46e5;
    }

    .history-item span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .sidebar-footer {
        padding-top: 1.5rem;
        border-top: 1px solid #1f2937;
    }

    .utility-button-group {
        display: flex;
        justify-content: space-between;
        gap: 0.75rem;
    }

    .action-icon-button {
        flex-shrink: 0; 
        width: 2.75rem; 
        height: 2.75rem; 
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.75rem; 
        color: #ffffff;
        background-color: #1f2937;
    }
    
    .action-icon-button:hover {
        transform: translateY(-2px);
        filter: brightness(1.2);
    }

    .action-icon-button.summarize { background-color: #059669; }
    .action-icon-button.export { background-color: #2563eb; }
    .action-icon-button.clear { background-color: #dc2626; }

    /* --- CHAT AREA STYLING --- */
    .chat-main-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background-color: #030712;
        position: relative;
    }

    .chat-header-main {
        background-color: #111827;
        padding: 1.25rem 2rem;
        border-bottom: 1px solid #1f2937;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chat-header-main h1 {
        font-size: 1.25rem;
        font-weight: 700;
        background: linear-gradient(to right, #818cf8, #c084fc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    #sidebarToggle {
        background: #1f2937;
        border: 1px solid #374151;
        color: #e5e7eb;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        cursor: pointer;
        margin-right: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #chatLog {
        flex-grow: 1;
        overflow-y: auto;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .chat-message {
        padding: 1.25rem;
        border-radius: 1.25rem;
        max-width: 80%;
        line-height: 1.6;
        font-size: 0.95rem;
        position: relative;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .chat-message.user {
        align-self: flex-end;
        background-color: #4338ca;
        color: #ffffff;
        border-bottom-right-radius: 0.25rem;
    }

    .chat-message.ai {
        align-self: flex-start;
        background-color: #1f2937;
        color: #e5e7eb;
        border-bottom-left-radius: 0.25rem;
        border: 1px solid #374151;
    }

    .chat-input-area {
        padding: 1.5rem 2rem;
        background-color: #111827;
        border-top: 1px solid #1f2937;
    }

    .integrated-input-container {
        display: flex;
        align-items: flex-end;
        background-color: #030712;
        border-radius: 1rem;
        border: 1px solid #374151;
        padding: 0.5rem;
    }
    
    #chatInput {
        flex-grow: 1;
        min-height: 44px;
        max-height: 200px;
        padding: 0.75rem;
        background: transparent;
        border: none;
        color: #ffffff;
        resize: none;
        outline: none;
        font-family: inherit;
    }

    #sendChatButton {
        background-color: #4f46e5;
        color: white;
        width: 44px;
        height: 44px;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* --- MOBILE RESPONSIVENESS --- */
    @media (max-width: 768px) {
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            transform: translateX(-100%);
            width: 280px;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .chat-message { max-width: 95%; }
    }
</style>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>History</h2>
            <button onclick="createNewChat()" class="action-icon-button" title="New Session">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
            </button>
        </div>
        
        <ul class="history-list" id="historyList"></ul>

        <div class="sidebar-footer">
            <div class="utility-button-group">
                <button onclick="summarizeChat()" class="action-icon-button summarize" title="Summarize">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 00 2 2h12a2 2 0 00 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
                </button>
                <button onclick="exportChat()" class="action-icon-button export" title="Export">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><path d="M7 10l5 5 5-5"/><path d="M12 15V3"/></svg>
                </button>
                <button onclick="clearChat()" class="action-icon-button clear" title="Clear">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/><path d="M8 6V4a2 2 0 01 2-2h4a2 2 0 01 2 2v2"/></svg>
                </button>
            </div>
            <p id="localTimeDisplay" class="text-xs text-gray-500 mt-4 text-center"></p>
            <p id="userLocationDisplay" class="text-[10px] text-gray-600 mt-1 text-center"></p>
        </div>
    </aside>

    <main class="chat-main-area">
        <header class="chat-header-main">
            <div class="flex items-center">
                <button id="sidebarToggle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                </button>
                <h1>Career Companion AI</h1>
            </div>
            <div class="text-xs text-indigo-400 font-mono hidden md:block">MODEL: GEMINI-1.5-FLASH</div>
        </header>

        <div id="chatLog"></div>

        <div class="chat-input-area">
            <div class="integrated-input-container">
                <textarea id="chatInput" placeholder="Ask about jobs, CVs, or interview tips..." rows="1"></textarea>
                <button onclick="typeQuery()" id="sendChatButton">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3v7l15 2-15 2v7z"/></svg>
                </button>
            </div>
            <div id="loadingIndicator" class="hidden flex items-center justify-center gap-2 mt-3 text-indigo-400 text-sm">
                <div class="w-2 h-2 bg-indigo-500 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-indigo-500 rounded-full animate-bounce [animation-delay:-.3s]"></div>
                <div class="w-2 h-2 bg-indigo-500 rounded-full animate-bounce [animation-delay:-.5s]"></div>
                <span>AI is drafting response...</span>
            </div>
        </div>
    </main>
</div>

<script>
    // State Management
    let currentSessionId = localStorage.getItem('lastSessionId') || 'session_' + Date.now();
    const chatInput = document.getElementById('chatInput');
    const chatLog = document.getElementById('chatLog');
    const loadingIndicator = document.getElementById('loadingIndicator');

    // Initialization
    window.onload = () => {
        updateTime();
        setInterval(updateTime, 1000);
        getLocation();
        loadChatHistory();
        updateHistorySidebar();
        chatInput.focus();
    };

    function updateTime() {
        const now = new Date();
        document.getElementById('localTimeDisplay').textContent = now.toLocaleTimeString();
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('userLocationDisplay').textContent = 
                    `Region: ${pos.coords.latitude.toFixed(2)}, ${pos.coords.longitude.toFixed(2)}`;
            }, () => {
                document.getElementById('userLocationDisplay').textContent = "Location access denied";
            });
        }
    }

    function loadChatHistory() {
        chatLog.innerHTML = '';
        const history = getSessionHistory(currentSessionId);
        history.forEach(m => appendMessage(m.role, m.text));
    }

    // Chat Logic
    async function typeQuery() {
        const text = chatInput.value.trim();
        if (!text) return;

        appendMessage('user', text);
        chatInput.value = '';
        chatInput.style.height = 'auto';

        loadingIndicator.classList.remove('hidden');
        
        try {
            const history = getSessionHistory(currentSessionId);
            
            // FIX: Map "ai" role to "model" for Gemini API compatibility 
            // and use the Django URL tag to fix 404s
            const response = await fetch('{% url "users:gemini_proxy" %}', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    contents: history.map(m => ({
                        role: m.role === 'ai' ? 'model' : 'user',
                        text: m.text
                    })).concat({ role: 'user', text: text })
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Server error");
            }

            const data = await response.json();
            if (data.text) {
                appendMessage('ai', data.text);
                saveMessage(currentSessionId, 'user', text);
                saveMessage(currentSessionId, 'ai', data.text);
                updateHistorySidebar();
            }
        } catch (e) {
            console.error("Chat Error:", e);
            appendMessage('ai', "Error: " + e.message);
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }

    function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = `chat-message ${role}`;
        div.innerHTML = `<div class="font-bold text-[10px] uppercase mb-1 opacity-50">${role}</div><div>${text}</div>`;
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Storage Helpers
    function getSessionHistory(id) {
        const sessions = JSON.parse(localStorage.getItem('chat_sessions') || '{}');
        return sessions[id] || [];
    }

    function saveMessage(id, role, text) {
        const sessions = JSON.parse(localStorage.getItem('chat_sessions') || '{}');
        if (!sessions[id]) sessions[id] = [];
        sessions[id].push({ role, text });
        localStorage.setItem('chat_sessions', JSON.stringify(sessions));
    }

    function updateHistorySidebar() {
        const sessions = JSON.parse(localStorage.getItem('chat_sessions') || '{}');
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        
        Object.keys(sessions).sort().reverse().forEach(id => {
            const firstMsg = sessions[id][0]?.text || "New Conversation";
            const li = document.createElement('li');
            li.className = `history-item ${id === currentSessionId ? 'active' : ''}`;
            li.innerHTML = `<span>${firstMsg.substring(0, 30)}...</span>`;
            li.onclick = () => switchSession(id);
            list.appendChild(li);
        });
    }

    function switchSession(id) {
        currentSessionId = id;
        localStorage.setItem('lastSessionId', id);
        chatLog.innerHTML = '';
        getSessionHistory(id).forEach(m => appendMessage(m.role, m.text));
        updateHistorySidebar();
    }

    function createNewChat() {
        const newId = 'session_' + Date.now();
        switchSession(newId);
    }

    function clearChat() {
        if (confirm("Delete all history?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // UI Events
    document.getElementById('sidebarToggle').onclick = () => {
        const sidebar = document.getElementById('sidebar');
        if (window.innerWidth > 768) {
            sidebar.classList.toggle('is-collapsed');
        } else {
            sidebar.classList.toggle('open');
        }
    };

    chatInput.oninput = function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    };

    chatInput.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            typeQuery();
        }
    };
</script>
{% endblock %}