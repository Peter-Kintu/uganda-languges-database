{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ accommodation.name }} | The Collection Africa{% endblock %}

{% block content %}
<div class="bg-[#020617] min-h-screen text-slate-300 font-sans selection:bg-indigo-500/30 overflow-x-hidden">
    
    <div class="fixed top-0 left-1/2 -translate-x-1/2 w-full h-[800px] bg-indigo-600/10 blur-[180px] pointer-events-none"></div>

    <div class="max-w-[1400px] mx-auto px-0 md:px-6 lg:pt-8 relative z-10">
        <div class="relative group h-[50vh] md:h-[75vh] w-full overflow-hidden md:rounded-[48px] shadow-2xl border border-white/5">
            <img src="{% if accommodation.image %}{{ accommodation.image.url }}{% else %}{{ accommodation.image_url }}{% endif %}" 
                 class="w-full h-full object-cover transition duration-[10s] group-hover:scale-105"
                 alt="{{ accommodation.name }}">
            
            <div class="absolute inset-0 bg-gradient-to-t from-[#020617] via-transparent to-black/20"></div>

            <div class="absolute top-8 left-8 flex flex-wrap gap-3">
                <a href="{% url 'hotel:hotel_list' %}" class="bg-black/40 backdrop-blur-xl border border-white/10 text-white px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-white hover:text-black transition-all">
                    ← Back to Collection
                </a>
                {% if accommodation.is_verified_vendor %}
                <span class="bg-indigo-600 text-white px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-500/20">
                    ✓ Verified Sanctuary
                </span>
                {% endif %}
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 mt-12 px-6 md:px-0">
            <div class="lg:col-span-8 space-y-12 pb-24">
                <div class="space-y-4">
                    <div class="flex items-center gap-4">
                        <span class="text-indigo-500 font-black text-[10px] uppercase tracking-[0.4em]">{{ accommodation.city }}, {{ accommodation.country }}</span>
                        <div class="h-[1px] flex-1 bg-white/5"></div>
                    </div>
                    <h1 class="text-5xl md:text-7xl font-black text-white tracking-tighter italic leading-none uppercase">
                        {{ accommodation.name }}
                    </h1>
                </div>

                <div class="prose prose-invert max-w-none">
                    <p class="text-xl md:text-2xl text-slate-400 font-light leading-relaxed italic">
                        {{ accommodation.description }}
                    </p>
                </div>

                {% if accommodation.latitude and accommodation.longitude %}
                <div class="bg-white/5 border border-white/10 rounded-[40px] p-8 md:p-12">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h3 class="text-white font-black uppercase tracking-widest text-xs">Geospatial Context</h3>
                            <p class="text-slate-500 text-[10px] mt-1 font-mono uppercase tracking-tighter">
                                Lat: {{ accommodation.latitude }} • Lon: {{ accommodation.longitude }}
                            </p>
                        </div>
                        
                        <div id="proximity-status" class="hidden flex items-center gap-3 bg-indigo-500/10 border border-indigo-500/20 px-4 py-2 rounded-full">
                            <span class="relative flex h-2 w-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"></span>
                            </span>
                            <span class="text-indigo-400 text-[9px] font-black uppercase tracking-widest">Property Unlocked (Within 5KM)</span>
                        </div>
                    </div>
                    
                    <div class="relative h-64 w-full bg-[#0f172a] rounded-[30px] overflow-hidden border border-white/5 group">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                                <div class="relative flex h-12 w-12 mx-auto mb-4">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-20"></span>
                                    <span class="relative inline-flex rounded-full h-12 w-12 bg-indigo-500/20 border border-indigo-500 flex items-center justify-center text-indigo-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </span>
                                </div>
                                <p class="text-[9px] font-black text-white/40 uppercase tracking-widest italic">Global Discovery Engine Active</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if accommodation.tiktok_url %}
                <div class="pt-12">
                    <a href="{{ accommodation.tiktok_url }}" target="_blank" class="inline-flex items-center gap-6 group">
                        <div class="w-20 h-20 rounded-full border border-white/10 flex items-center justify-center group-hover:border-indigo-500 transition-all">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-black fill-current" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.28-2.26.74-4.63 2.58-5.91 1.36-1.01 3.08-1.56 4.77-1.44v4.04c-.77-.13-1.61-.09-2.34.2-.84.3-1.6 1.05-1.78 1.9-.12.52-.12 1.06-.01 1.58.21.91.89 1.69 1.74 2.05.58.26 1.23.35 1.86.3 1.25-.04 2.45-.76 2.94-1.91.13-.3.17-.63.18-.95V.02z"/></svg>
                            </div>
                        </div>
                        <div>
                            <span class="block text-white font-black uppercase tracking-widest text-xs">Motion Tour</span>
                            <span class="text-slate-500 text-[10px] uppercase font-black">View on TikTok</span>
                        </div>
                    </a>
                </div>
                {% endif %}
            </div>

            <div class="lg:col-span-4 pb-24">
                <div class="sticky top-12 bg-white/5 border border-white/10 rounded-[40px] p-10 backdrop-blur-3xl shadow-2xl">
                    <div class="flex items-center justify-between mb-10">
                        <div>
                            <span class="text-slate-500 text-[8px] font-black uppercase tracking-widest block mb-2">Investment</span>
                            <div class="flex items-baseline gap-2">
                                <span class="text-indigo-400 text-xs font-black">{{ accommodation.currency }}</span>
                                <span class="text-5xl font-black text-white tracking-tighter">{{ accommodation.price_per_night|floatformat:0 }}</span>
                                <span class="text-slate-500 text-[10px] font-light">/night</span>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            {% if accommodation.stars > 0 %}
                                {% with ''|center:accommodation.stars as range %}{% for _ in range %}<span class="text-indigo-500 text-[10px]">★</span>{% endfor %}{% endwith %}
                            {% else %}
                                <span class="text-indigo-400 font-black text-[8px] uppercase tracking-widest border border-indigo-500/30 px-3 py-1 rounded-full">Elite</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="space-y-6">
                        <a href="{% url 'hotel:book_hotel' accommodation.pk %}" class="flex items-center justify-center gap-4 w-full bg-white text-black hover:bg-indigo-600 hover:text-white font-black py-7 rounded-[20px] transition-all transform hover:-translate-y-1 shadow-xl group">
                            <span class="uppercase tracking-[0.2em] text-[10px]">
                                {% if accommodation.source == 'travelpayouts' %}Global Reservation{% else %}Concierge Access{% endif %}
                            </span>
                        </a>
                        <div class="pt-8 border-t border-white/5 flex items-center justify-between opacity-50">
                            <span class="text-[8px] text-slate-500 font-black uppercase tracking-widest">Verified Boutique</span>
                            <span class="text-[8px] text-slate-500 font-black uppercase tracking-widest italic">Secure Protocol</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        /**
         * SAFE EXPRESSION HANDLING:
         * We use parseFloat combined with string interpolation and the default filter
         * to prevent "Expression expected" errors if the field is empty in the database.
         */
        const destLat = parseFloat("{{ accommodation.latitude|default:'0' }}");
        const destLon = parseFloat("{{ accommodation.longitude|default:'0' }}");

        // Only proceed if we have valid coordinates and browser support
        if (destLat !== 0 && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    
                    // Calculation for ~5km proximity radius
                    const diffLat = Math.abs(userLat - destLat);
                    const diffLon = Math.abs(userLon - destLon);

                    // 0.045 degrees is approximately 5KM
                    if (diffLat < 0.045 && diffLon < 0.045) {
                        const statusBadge = document.getElementById('proximity-status');
                        if (statusBadge) {
                            statusBadge.classList.remove('hidden');
                            statusBadge.classList.add('flex');
                        }
                    }
                },
                (err) => console.log("Geolocation permission denied or timed out.")
            );
        }
    });
</script>
{% endblock %}