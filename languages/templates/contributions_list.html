{% extends "base.html" %}

{% block title %}Job Listings | Global Job Board{% endblock %}

{% block extra_head %}
    <style>
        body {
            background-color: #0f172a; /* slate-900 */
            color: #f8fafc; /* white */
        }
        .nav-link.active {
            color: #818cf8;
            border-bottom: 2px solid #818cf8;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4f46e5; /* indigo-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6366f1; /* indigo-500 */
        }
        .drawer-close {
            transform: translateX(-100%);
        }
        .drawer-open {
            transform: translateX(0);
        }
        .drawer-glass {
            background-color: rgba(30, 41, 59, 0.95); /* slate-800 with transparency */
            backdrop-filter: blur(5px);
        }
        
        /* NEW: Class for subtle hover glow */
        .job-card-hover:hover {
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); /* indigo-500 shadow */
        }

        /* Styles for the Read More/Less toggle */
        .collapsed-content {
            max-height: 4rem; /* Hides overflow for job content */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .expanded-content {
            max-height: 1000px; /* Large height to ensure full content is visible */
        }
        /* Text fading effect for collapsed state */
        .text-fade-bottom {
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
        }
    </style>
{% endblock %}

{% block content %}
<main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h1 class="text-4xl font-extrabold text-white mb-8 border-b border-indigo-500 pb-2">{{ page_title }}</h1>

    <form method="get" action="{% url 'languages:browse_job_listings' %}" class="mb-8 p-6 bg-gray-800 rounded-lg shadow-2xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="search" name="q" placeholder="Search by Job Description, Skills, or Company Name..." value="{{ search_query }}" class="col-span-1 md:col-span-2 px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
            
            <select name="category" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="all">All Categories</option>
                {% for category_key, category_label in job_categories %}
                    <option value="{{ category_key }}" {% if category_key == selected_category %}selected{% endif %}>
                        {{ category_label }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="mt-4 flex justify-end">
            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition duration-150 ease-in-out">
                Apply Filters
            </button>
        </div>
    </form>
    
    {% if user.is_authenticated and job_posts.number == 1 and recommended_jobs_count > 0 %}
    <section class="mb-12">
        <h2 class="text-3xl font-bold text-indigo-400 mb-6 flex items-center">
            <svg class="w-8 h-8 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Recommended Jobs For You
        </h2>
        
        <div class="space-y-6">
            {% for job in job_posts %}
                {% if forloop.counter <= recommended_jobs_count %}
                {# Only show the recommended subset from the paginated list on the first page #}
                {# MODIFIED: Reduced card padding on mobile to p-4 #}
                <div class="bg-gray-800 rounded-xl shadow-2xl p-4 md:p-6 transition duration-300 ease-in-out border-2 border-indigo-500 hover:bg-gray-700/50 job-card-hover">
                    <div class="flex items-start md:flex-row md:justify-between md:items-start">
                        
                        {% if job.company_logo_or_media %}
                            {# MODIFIED: Reduced logo size on mobile (h-12 w-12) and added right margin (mr-4) #}
                            <div class="mr-4 md:mb-0 md:mr-6 flex-shrink-0">
                                <img src="{{ job.company_logo_or_media.url }}" alt="{{ job.recruiter_name }} Logo" class="h-12 w-12 md:h-16 md:w-16 object-contain rounded-lg border border-gray-600 p-1 bg-white">
                            </div>
                        {% endif %}

                        <div class="flex-grow min-w-0">
                            {# Updated Layout for Mobile Stacking #}
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-1">
                                {# MODIFIED: Reduced text size on mobile (text-lg) and added truncate #}
                                <h2 class="text-lg md:text-xl font-bold text-white leading-tight mb-1 sm:mb-0 truncate">
                                    {{ job.post_content|truncatechars:70 }} 
                                    {% if job.post_content|length > 70 %}...{% endif %}
                                </h2>
                                <span class="sm:ml-4 px-3 py-1 text-xs font-semibold rounded-full bg-indigo-600 text-white uppercase flex-shrink-0 self-start">{{ job.get_job_category_display }}</span>
                            </div>
                            
                            {# MODIFIED: Reduced margin (mb-1) and text size (text-xs) for compactness #}
                            <p class="text-gray-400 text-xs mb-1">
                                <span class="font-medium text-indigo-400">{{ job.recruiter_name }}</span> 
                                — 
                                <span>{{ job.recruiter_location }}</span>
                            </p>

                            {# Expandable Job Content #}
                            <div id="recommended-details-{{ job.pk }}">
                                {# MODIFIED: Reduced margin to mb-1 #}
                                <p class="text-gray-300 text-sm mb-1 collapsed-content text-fade-bottom" data-job-content>
                                    {{ job.post_content }}
                                </p>
                                {# MODIFIED: Reduced margin to mb-2 #}
                                <p class="text-gray-300 text-sm mb-2" data-job-skills>
                                    <strong class="text-indigo-300">Skills:</strong> {{ job.required_skills }}
                                </p>
                            </div>
                            
                            {% if job.post_content|length > 70 or job.required_skills|length > 120 %}
                            {# MODIFIED: Reduced margin to mb-1 #}
                            <button onclick="toggleDetails('recommended-details-{{ job.pk }}', this)" class="text-indigo-400 hover:text-indigo-300 text-sm font-medium mt-1 mb-1 transition duration-150 ease-in-out flex items-center">
                                Read More
                                <svg class="w-4 h-4 ml-1 transform transition duration-300 ease-in-out" data-toggle-icon xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            {% endif %}
                            
                            {# MODIFIED: Reduced text size and space (text-xs, space-x-2) and removed separator #}
                            <div class="flex items-center text-xs text-gray-500 space-x-2">
                                <span class="font-medium uppercase border border-gray-600 px-2 py-0.5 rounded-full">{{ job.get_job_type_display }}</span>
                                <span>Posted: {{ job.timestamp|date:"M d, Y" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-center">
                        
                        {% if job.application_url %}
                        <a href="{{ job.application_url }}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150 ease-in-out text-sm">
                            Apply Now
                        </a>
                        {% else %}
                        {# NEW: Easy Apply Button - NOW PASSING EMAIL/WHATSAPP #}
                        <button onclick="openEasyApplyModal('{{ job.post_content|escapejs }}', '{{ job.recruiter_name|escapejs }}', '{{ job.recruiter_email|escapejs }}', '{{ job.recruiter_whatsapp|escapejs }}')" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150 ease-in-out text-sm">
                            Easy Apply
                        </button>
                        {% endif %}
                        
                        <form method="post" action="{% url 'languages:upvote_job_application' pk=job.pk %}" class="upvote-form flex items-center">
                            {% csrf_token %}
                            <button type="submit" class="text-gray-400 hover:text-indigo-400 transition duration-150 ease-in-out flex items-center space-x-1">
                                <svg class="h-5 w-5 fill-current" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                </svg>
                                <span class="upvote-count font-semibold text-lg">{{ job.upvotes }}</span>
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </section>

    <h2 class="text-3xl font-bold text-indigo-400 mb-6 border-b border-gray-700 pb-2">All Other Listings</h2>
    {% elif user.is_authenticated and not recommended_jobs_count and job_posts.number == 1 %}
    <div class="text-center py-6 bg-gray-800 rounded-lg shadow-2xl border border-gray-700 mb-8">
        <p class="text-lg font-medium text-gray-300">No current recommendations based on your profile skills.</p>
        <p class="text-gray-400 mt-1 text-sm">Below are all available job listings.</p>
    </div>
    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2">All Job Listings</h2>
    {% else %}
    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2">All Job Listings</h2>
    {% endif %}

    <div class="space-y-6">
        {% if job_posts %}
            {% for job in job_posts %}
                {# If on page 1 and recommendations exist, skip the recommended ones in the main list #}
                {% if not user.is_authenticated or job_posts.number != 1 or forloop.counter > recommended_jobs_count %}
                {# Updated Card Styling #}
                {# MODIFIED: Reduced card padding on mobile to p-4 #}
                <div class="bg-gray-800 rounded-xl shadow-xl p-4 md:p-6 transition duration-300 ease-in-out hover:bg-gray-700/50 border border-gray-700 job-card-hover">
                    <div class="flex items-start md:flex-row md:justify-between md:items-start">
                        
                        {% if job.company_logo_or_media %}
                            {# MODIFIED: Reduced logo size on mobile (h-12 w-12) and added right margin (mr-4) #}
                            <div class="mr-4 md:mb-0 md:mr-6 flex-shrink-0">
                                <img src="{{ job.company_logo_or_media.url }}" alt="{{ job.recruiter_name }} Logo" class="h-12 w-12 md:h-16 md:w-16 object-contain rounded-lg border border-gray-600 p-1 bg-white">
                            </div>
                        {% endif %}

                        <div class="flex-grow min-w-0">
                            {# Updated Layout for Mobile Stacking #}
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-1">
                                {# MODIFIED: Reduced text size on mobile (text-lg) and added truncate #}
                                <h2 class="text-lg md:text-xl font-bold text-white leading-tight mb-1 sm:mb-0 truncate">
                                    {{ job.post_content|truncatechars:70 }} 
                                    {% if job.post_content|length > 70 %}...{% endif %}
                                </h2>
                                <span class="sm:ml-4 px-3 py-1 text-xs font-semibold rounded-full bg-indigo-600 text-white uppercase flex-shrink-0 self-start">{{ job.get_job_category_display }}</span>
                            </div>
                            
                            {# MODIFIED: Reduced margin (mb-1) and text size (text-xs) for compactness #}
                            <p class="text-gray-400 text-xs mb-1">
                                <span class="font-medium text-indigo-400">{{ job.recruiter_name }}</span> 
                                — 
                                <span>{{ job.recruiter_location }}</span>
                            </p>

                            {# Expandable Job Content #}
                            <div id="main-details-{{ job.pk }}">
                                {# MODIFIED: Reduced margin to mb-1 #}
                                <p class="text-gray-300 text-sm mb-1 collapsed-content text-fade-bottom" data-job-content>
                                    {{ job.post_content }}
                                </p>
                                {# MODIFIED: Reduced margin to mb-2 #}
                                <p class="text-gray-300 text-sm mb-2" data-job-skills>
                                    <strong class="text-indigo-300">Skills:</strong> {{ job.required_skills }}
                                </p>
                            </div>
                            
                            {% if job.post_content|length > 70 or job.required_skills|length > 120 %}
                            {# MODIFIED: Reduced margin to mb-1 #}
                            <button onclick="toggleDetails('main-details-{{ job.pk }}', this)" class="text-indigo-400 hover:text-indigo-300 text-sm font-medium mt-1 mb-1 transition duration-150 ease-in-out flex items-center">
                                Read More
                                <svg class="w-4 h-4 ml-1 transform transition duration-300 ease-in-out" data-toggle-icon xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            {% endif %}
                            
                            {# MODIFIED: Reduced text size and space (text-xs, space-x-2) and removed separator #}
                            <div class="flex items-center text-xs text-gray-500 space-x-2">
                                <span class="font-medium uppercase border border-gray-600 px-2 py-0.5 rounded-full">{{ job.get_job_type_display }}</span>
                                <span>Posted: {{ job.timestamp|date:"M d, Y" }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-center">
                        
                        {% if job.application_url %}
                        <a href="{{ job.application_url }}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150 ease-in-out text-sm">
                            Apply Now
                        </a>
                        {% else %}
                        {# NEW: Easy Apply Button - NOW PASSING EMAIL/WHATSAPP #}
                        <button onclick="openEasyApplyModal('{{ job.post_content|escapejs }}', '{{ job.recruiter_name|escapejs }}', '{{ job.recruiter_email|escapejs }}', '{{ job.recruiter_whatsapp|escapejs }}')" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150 ease-in-out text-sm">
                            Easy Apply
                        </button>
                        {% endif %}
                        
                        <form method="post" action="{% url 'languages:upvote_job_application' pk=job.pk %}" class="upvote-form flex items-center">
                            {% csrf_token %}
                            <button type="submit" class="text-gray-400 hover:text-indigo-400 transition duration-150 ease-in-out flex items-center space-x-1">
                                <svg class="h-5 w-5 fill-current" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                </svg>
                                <span class="upvote-count font-semibold text-lg">{{ job.upvotes }}</span>
                            </button>
                        </form>
                        
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="text-center py-12 bg-gray-800 rounded-lg shadow-2xl border border-gray-700">
                <p class="text-2xl font-semibold text-indigo-400 mb-2">No Job Listings Found</p>
                <p class="text-gray-400 mt-2">Try adjusting your search filters or be the first to post a job <a href="{% url 'languages:post_job' %}" class="text-indigo-400 hover:text-indigo-300 font-medium">here</a>.</p>
            </div>
        {% endif %}
    </div>
    
    {% if job_posts.has_other_pages %}
        {% with job_posts.paginator.page_range as page_range %}
        <div class="flex justify-center mt-10">
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                
                {% comment %} Previous Button {% endcomment %}
                {% if job_posts.has_previous %}
                    <a href="?page={{ job_posts.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-700 bg-gray-800 text-sm font-medium text-gray-400 hover:bg-gray-700">
                        <span class="sr-only">Previous</span>
                        &larr; Previous
                    </a>
                {% endif %}
                
                {% comment %} Page Numbers Loop {% endcomment %}
                {% for i in page_range %}
                    <a href="?page={{ i }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-700 text-sm font-medium 
                        {% if job_posts.number == i %}
                            bg-indigo-600 text-white hover:bg-indigo-500
                        {% else %}
                            bg-gray-800 text-gray-400 hover:bg-gray-700
                        {% endif %}
                        ">
                        {{ i }}
                    </a>
                {% endfor %}
                
                {% comment %} Next Button {% endcomment %}
                {% if job_posts.has_next %}
                    <a href="?page={{ job_posts.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-700 bg-gray-800 text-sm font-medium text-gray-400 hover:bg-gray-700">
                        Next &rarr;
                    </a>
                {% endif %}
            </nav>
        </div>
        {% endwith %}
    {% endif %}
</main>

<div id="easyApplyModal" class="fixed inset-0 z-50 hidden overflow-y-auto bg-gray-900 bg-opacity-80 backdrop-blur-sm transition-opacity duration-300">
    <div class="flex items-center justify-center min-h-screen px-4 py-8">
        <div class="bg-gray-800 w-full max-w-lg mx-auto rounded-xl shadow-2xl p-6 md:p-8 transform transition-all duration-300 scale-95 opacity-0" id="easyApplyModalContent">
            <div class="flex justify-between items-start border-b border-gray-700 pb-3 mb-4">
                <h3 class="text-2xl font-bold text-indigo-400">Easy Application</h3>
                <button onclick="closeEasyApplyModal()" class="text-gray-400 hover:text-white transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <p class="text-gray-300 mb-4">Applying for: <span id="modal-job-title" class="font-semibold text-white italic"></span></p>
            <p class="text-gray-400 mb-6 text-sm">You are applying to <span id="modal-recruiter-name" class="font-medium text-indigo-300"></span>.</p>

            <form id="easyApplyForm" class="space-y-6">
                <div class="space-y-2">
                    <label for="cvFile" class="block text-sm font-medium text-indigo-300">Upload Your CV/Resume (PDF/DOCX)</label>
                    <input type="file" id="cvFile" name="cvFile" accept=".pdf,.doc,.docx" required 
                           class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 file:cursor-pointer transition duration-150 ease-in-out">
                    <p class="text-xs text-gray-500 mt-1">Maximum file size: 5MB</p>
                </div>
                
                <div class="space-y-2">
                    <label for="applicationMethod" class="block text-sm font-medium text-indigo-300">Select Submission Method</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="applicationMethod" value="email" required class="form-radio h-4 w-4 text-indigo-600 bg-gray-700 border-gray-600 focus:ring-indigo-500" checked>
                            <span class="ml-2 text-white">Email</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="applicationMethod" value="whatsapp" required class="form-radio h-4 w-4 text-green-600 bg-gray-700 border-gray-600 focus:ring-green-500">
                            <span class="ml-2 text-white">WhatsApp</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full py-3 px-4 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition duration-150 ease-in-out">
                    Continue to Application
                </button>
            </form>

            <div id="applicationActionMessage" class="hidden mt-4 p-3 rounded-md text-sm">
                
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block footer_scripts %}
    {{ block.super }}
    <script>
        
        // Function to toggle job details (Read More/Less)
        function toggleDetails(id, button) {
            const container = document.getElementById(id);
            const content = container.querySelector('[data-job-content]');
            const icon = button.querySelector('[data-toggle-icon]');

            // Check if the content is currently expanded
            if (content.classList.contains('expanded-content')) {
                // Collapse
                content.classList.remove('expanded-content');
                content.classList.add('collapsed-content');
                content.classList.add('text-fade-bottom'); // Reapply fade effect
                
                button.innerHTML = 'Read More <svg class="w-4 h-4 ml-1 transform transition duration-300 ease-in-out" data-toggle-icon xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>';
            } else {
                // Expand
                content.classList.remove('collapsed-content');
                content.classList.remove('text-fade-bottom'); // Remove fade effect
                content.classList.add('expanded-content');
                
                button.innerHTML = 'Read Less <svg class="w-4 h-4 ml-1 transform rotate-180 transition duration-300 ease-in-out" data-toggle-icon xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>';
            }
        }
        
        // Initialize collapsed state for all job content on page load
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('[data-job-content]').forEach(content => {
                // Only collapse if the content is actually longer than the truncated amount (assuming 4 lines in max-h-16)
                if (content.scrollHeight > content.clientHeight) {
                    content.classList.add('collapsed-content');
                    content.classList.add('text-fade-bottom');
                }
            });
        });


        // Simple AJAX for Upvoting
        document.querySelectorAll('.upvote-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const form = this;
                const upvoteCountElement = form.querySelector('.upvote-count');
                const url = form.action;
                const formData = new FormData(form);

                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        upvoteCountElement.textContent = data.new_upvotes;
                    } else {
                        console.error('Upvote failed');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });

        // ==========================================================
        // NEW: Easy Apply Modal Functions
        // ==========================================================
        const modal = document.getElementById('easyApplyModal');
        const modalContent = document.getElementById('easyApplyModalContent');
        const modalJobTitle = document.getElementById('modal-job-title');
        const modalRecruiterName = document.getElementById('modal-recruiter-name');
        const easyApplyForm = document.getElementById('easyApplyForm');
        const applicationActionMessage = document.getElementById('applicationActionMessage');
        
        // Variables to hold job data context
        let currentRecruiterName = '';
        let currentJobTitle = '';
        let currentRecruiterEmail = '';
        let currentRecruiterWhatsApp = '';
        
        // Updated function signature to accept contact details
        function openEasyApplyModal(jobTitle, recruiterName, recruiterEmail, recruiterWhatsApp) {
            // Remove truncation marks for display in modal and set context
            currentJobTitle = jobTitle.replace('...', '').trim(); 
            currentRecruiterName = recruiterName.trim();
            // Set the new contact context, trimming potential white spaces from Django template
            currentRecruiterEmail = recruiterEmail.trim();
            currentRecruiterWhatsApp = recruiterWhatsApp.trim();
            
            modalJobTitle.textContent = currentJobTitle;
            modalRecruiterName.textContent = currentRecruiterName;

            // Reset form visibility and message
            easyApplyForm.classList.remove('hidden');
            applicationActionMessage.classList.add('hidden');
            applicationActionMessage.innerHTML = '';
            easyApplyForm.reset(); 

            // Show and animate modal
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeEasyApplyModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('opacity-100');
            }, 300);
        }

        // Handle form submission - now uses dynamic email/WhatsApp variables
        easyApplyForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const method = document.querySelector('input[name="applicationMethod"]:checked').value;
            const cvFile = document.getElementById('cvFile').files[0];
            
            if (!cvFile) {
                alert('Please upload your CV/Resume.');
                return;
            }

            let actionText = '';
            
            const subject = `Job Application: ${currentJobTitle}`;
            const emailBody = `Dear ${currentRecruiterName},\n\nPlease find my CV attached for the role of ${currentJobTitle} I found on your job board.`;
            const whatsappBody = `Hello ${currentRecruiterName}, I am applying for the role of ${currentJobTitle}. My CV is attached to this message.`;
            
            // Fallback for phone number display in case the field is empty
            const phoneNumber = currentRecruiterWhatsApp || 'N/A (Not Provided)'; 

            if (method === 'email') {
                const mailtoLink = `mailto:${currentRecruiterEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                
                actionText = `
                    <div class="bg-indigo-600 p-3 rounded-lg">
                        <p class="font-semibold text-white mb-2">Email Application Instructions (to: <span class="text-yellow-300 font-bold">${currentRecruiterEmail || 'N/A (Not Provided)'}</span>):</p>
                        <p class="text-white">1. Click the button below to open your email client.</p>
                        <p class="text-white">2. **Crucially, manually attach** your uploaded CV (${cvFile.name}) to the email.</p>
                        <p class="text-white mb-3">3. Send the pre-filled email.</p>
                        <a href="${currentRecruiterEmail ? mailtoLink : '#'}" target="_blank" class="w-full inline-flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-indigo-900 bg-yellow-300 hover:bg-yellow-400 transition duration-150 ${currentRecruiterEmail ? '' : 'opacity-50 cursor-not-allowed'}">
                            Open Email to Attach & Send
                        </a>
                    </div>
                `;
            } else if (method === 'whatsapp') {
                // Use wa.me for web/mobile compatibility
                const whatsappLink = `https://wa.me/${currentRecruiterWhatsApp}?text=${encodeURIComponent(whatsappBody)}`;
                
                actionText = `
                    <div class="bg-green-700 p-3 rounded-lg">
                        <p class="font-semibold text-white mb-2">WhatsApp Application Instructions (to: <span class="text-white font-bold">${phoneNumber}</span>):</p>
                        <p class="text-white">1. Click the button below to open WhatsApp chat.</p>
                        <p class="text-white">2. **Crucially, manually attach** your uploaded CV (${cvFile.name}) to the message.</p>
                        <p class="text-white mb-3">3. Send the pre-filled message.</p>
                        <a href="${currentRecruiterWhatsApp ? whatsappLink : '#'}" target="_blank" class="w-full inline-flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-green-900 bg-white hover:bg-gray-100 transition duration-150 ${currentRecruiterWhatsApp ? '' : 'opacity-50 cursor-not-allowed'}">
                            Open WhatsApp to Attach & Send
                        </a>
                    </div>
                `;
            }

            // Display the instructions to the user and hide the form
            document.getElementById('easyApplyForm').classList.add('hidden');
            applicationActionMessage.innerHTML = actionText;
            applicationActionMessage.classList.remove('hidden');
        });

        // Hide the modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target.id === 'easyApplyModal') {
                closeEasyApplyModal();
            }
        });
    </script>
{% endblock footer_scripts %}