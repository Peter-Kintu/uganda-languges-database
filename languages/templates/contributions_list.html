{% extends "base.html" %}

{% block title %}Job Listings | Global Job Board{% endblock %}

{% block extra_head %}
    <style>
        body {
            background-color: #0f172a; /* slate-900 */
            color: #f8fafc; /* white */
        }
        .nav-link.active {
            color: #818cf8;
            border-bottom: 2px solid #818cf8;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4f46e5; /* indigo-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6366f1; /* indigo-500 */
        }
        .drawer-close {
            transform: translateX(-100%);
        }
        .drawer-open {
            transform: translateX(0);
        }
        .drawer-glass {
            background-color: rgba(30, 41, 59, 0.95); /* slate-800 with transparency */
            backdrop-filter: blur(5px);
        }
    </style>
{% endblock %}

{% block content %}
<main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h1 class="text-4xl font-extrabold text-white mb-8 border-b border-indigo-500 pb-2">{{ page_title }}</h1>

    <form method="get" action="{% url 'languages:browse_job_listings' %}" class="mb-8 p-6 bg-gray-800 rounded-lg shadow-2xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="search" name="q" placeholder="Search by Job Description, Skills, or Company Name..." value="{{ search_query }}" class="col-span-1 md:col-span-2 px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
            
            <select name="category" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="all">All Categories</option>
                {% for category_key, category_label in job_categories %}
                    <option value="{{ category_key }}" {% if category_key == selected_category %}selected{% endif %}>
                        {{ category_label }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="mt-4 flex justify-end">
            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition duration-150 ease-in-out">
                Apply Filters
            </button>
        </div>
    </form>
    
    {% if user.is_authenticated and job_posts.number == 1 and recommended_jobs_count > 0 %}
    <section class="mb-12">
        <h2 class="text-3xl font-bold text-indigo-400 mb-6 flex items-center">
            <svg class="w-8 h-8 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Recommended Jobs For You
        </h2>
        
        <div class="space-y-6">
            {% for job in job_posts %}
                {% if forloop.counter <= recommended_jobs_count %}
                {# Only show the recommended subset from the paginated list on the first page #}
                <div class="bg-gray-800 rounded-lg shadow-2xl p-6 transition duration-300 ease-in-out border-2 border-indigo-500 hover:bg-gray-700/50">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-start">
                        
                        {% if job.company_logo_or_media %}
                            <div class="mb-4 md:mb-0 md:mr-6 flex-shrink-0">
                                <img src="{{ job.company_logo_or_media.url }}" alt="{{ job.recruiter_name }} Logo" class="h-16 w-16 object-contain rounded-lg border border-gray-600 p-1 bg-white">
                            </div>
                        {% endif %}

                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-2">
                                <h2 class="text-xl font-bold text-white leading-tight">
                                    {{ job.post_content|truncatechars:70 }} 
                                    {% if job.post_content|length > 70 %}...{% endif %}
                                </h2>
                                <span class="ml-4 px-3 py-1 text-xs font-semibold rounded-full bg-indigo-600 text-white uppercase flex-shrink-0">{{ job.get_job_category_display }}</span>
                            </div>
                            
                            <p class="text-gray-400 text-sm mb-3">
                                <span class="font-medium text-indigo-400">{{ job.recruiter_name }}</span> 
                                — 
                                <span>{{ job.recruiter_location }}</span>
                            </p>

                            <p class="text-gray-300 text-sm mb-4">
                                <strong class="text-indigo-300">Skills:</strong> {{ job.required_skills|truncatechars:120 }}
                            </p>
                            
                            <div class="flex items-center text-sm text-gray-500 space-x-4">
                                <span class="text-xs font-medium uppercase border border-gray-600 px-2 py-0.5 rounded-full">{{ job.get_job_type_display }}</span>
                                <span class="text-gray-600 hidden sm:inline">|</span>
                                <span class="hidden sm:inline">Posted: {{ job.timestamp|date:"M d, Y" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-center">
                        
                        {% if job.application_url %}
                        <a href="{{ job.application_url }}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150 ease-in-out text-sm">
                            Apply Now
                        </a>
                        {% else %}
                        <span class="text-gray-500 text-sm italic">Application link not provided.</span>
                        {% endif %}
                        
                        <form method="post" action="{% url 'languages:upvote_job_application' pk=job.pk %}" class="upvote-form flex items-center">
                            {% csrf_token %}
                            <button type="submit" class="text-gray-400 hover:text-indigo-400 transition duration-150 ease-in-out flex items-center space-x-1">
                                <svg class="h-5 w-5 fill-current" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                </svg>
                                <span class="upvote-count font-semibold text-lg">{{ job.upvotes }}</span>
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </section>

    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2">All Other Listings</h2>
    {% elif user.is_authenticated and not recommended_jobs_count and job_posts.number == 1 %}
    <div class="text-center py-6 bg-gray-800 rounded-lg shadow-2xl border border-gray-700 mb-8">
        <p class="text-lg font-medium text-gray-300">No current recommendations based on your profile skills.</p>
        <p class="text-gray-400 mt-1 text-sm">Below are all available job listings.</p>
    </div>
    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2">All Job Listings</h2>
    {% else %}
    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2">All Job Listings</h2>
    {% endif %}

    <div class="space-y-6">
        {% if job_posts %}
            {% for job in job_posts %}
                {# If on page 1 and recommendations exist, skip the recommended ones in the main list #}
                {% if not user.is_authenticated or job_posts.number != 1 or forloop.counter > recommended_jobs_count %}
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 transition duration-300 ease-in-out hover:shadow-indigo-500/50 hover:bg-gray-700/50 border border-gray-700">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-start">
                        
                        {% if job.company_logo_or_media %}
                            <div class="mb-4 md:mb-0 md:mr-6 flex-shrink-0">
                                <img src="{{ job.company_logo_or_media.url }}" alt="{{ job.recruiter_name }} Logo" class="h-16 w-16 object-contain rounded-lg border border-gray-600 p-1 bg-white">
                            </div>
                        {% endif %}

                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-2">
                                <h2 class="text-xl font-bold text-white leading-tight">
                                    {{ job.post_content|truncatechars:70 }} 
                                    {% if job.post_content|length > 70 %}...{% endif %}
                                </h2>
                                <span class="ml-4 px-3 py-1 text-xs font-semibold rounded-full bg-indigo-600 text-white uppercase flex-shrink-0">{{ job.get_job_category_display }}</span>
                            </div>
                            
                            <p class="text-gray-400 text-sm mb-3">
                                <span class="font-medium text-indigo-400">{{ job.recruiter_name }}</span> 
                                — 
                                <span>{{ job.recruiter_location }}</span>
                            </p>

                            <p class="text-gray-300 text-sm mb-4">
                                <strong class="text-indigo-300">Skills:</strong> {{ job.required_skills|truncatechars:120 }}
                            </p>
                            
                            <div class="flex items-center text-sm text-gray-500 space-x-4">
                                <span class="text-xs font-medium uppercase border border-gray-600 px-2 py-0.5 rounded-full">{{ job.get_job_type_display }}</span>
                                <span class="text-gray-600 hidden sm:inline">|</span>
                                <span class="hidden sm:inline">Posted: {{ job.timestamp|date:"M d, Y" }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-center">
                        
                        {% if job.application_url %}
                        <a href="{{ job.application_url }}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150 ease-in-out text-sm">
                            Apply Now
                        </a>
                        {% else %}
                        <span class="text-gray-500 text-sm italic">Application link not provided.</span>
                        {% endif %}
                        
                        <form method="post" action="{% url 'languages:upvote_job_application' pk=job.pk %}" class="upvote-form flex items-center">
                            {% csrf_token %}
                            <button type="submit" class="text-gray-400 hover:text-indigo-400 transition duration-150 ease-in-out flex items-center space-x-1">
                                <svg class="h-5 w-5 fill-current" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                </svg>
                                <span class="upvote-count font-semibold text-lg">{{ job.upvotes }}</span>
                            </button>
                        </form>
                        
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="text-center py-12 bg-gray-800 rounded-lg shadow-2xl border border-gray-700">
                <p class="text-2xl font-semibold text-indigo-400 mb-2">No Job Listings Found</p>
                <p class="text-gray-400 mt-2">Try adjusting your search filters or be the first to post a job <a href="{% url 'languages:post_job' %}" class="text-indigo-400 hover:text-indigo-300 font-medium">here</a>.</p>
            </div>
        {% endif %}
    </div>
    
    {% if job_posts.has_other_pages %}
        {% with job_posts.paginator.page_range as page_range %}
        <div class="flex justify-center mt-10">
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                
                {% comment %} Previous Button {% endcomment %}
                {% if job_posts.has_previous %}
                    <a href="?page={{ job_posts.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-700 bg-gray-800 text-sm font-medium text-gray-400 hover:bg-gray-700">
                        <span class="sr-only">Previous</span>
                        &larr; Previous
                    </a>
                {% endif %}
                
                {% comment %} Page Numbers Loop {% endcomment %}
                {% for i in page_range %}
                    <a href="?page={{ i }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-700 text-sm font-medium 
                        {% if job_posts.number == i %}
                            bg-indigo-600 text-white hover:bg-indigo-500
                        {% else %}
                            bg-gray-800 text-gray-400 hover:bg-gray-700
                        {% endif %}
                        ">
                        {{ i }}
                    </a>
                {% endfor %}
                
                {% comment %} Next Button {% endcomment %}
                {% if job_posts.has_next %}
                    <a href="?page={{ job_posts.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-700 bg-gray-800 text-sm font-medium text-gray-400 hover:bg-gray-700">
                        Next &rarr;
                    </a>
                {% endif %}
            </nav>
        </div>
        {% endwith %}
    {% endif %}
</main>
{% endblock content %}

{% block footer_scripts %}
    {{ block.super }}
    <script>
        // Simple AJAX for Upvoting
        document.querySelectorAll('.upvote-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const form = this;
                const upvoteCountElement = form.querySelector('.upvote-count');
                const url = form.action;
                const formData = new FormData(form);

                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        upvoteCountElement.textContent = data.new_upvotes;
                    } else {
                        console.error('Upvote failed');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    </script>
{% endblock footer_scripts %}