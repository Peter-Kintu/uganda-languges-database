{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Negotiate Price for {{ product.name }}{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-12">
    <div class="max-w-3xl mx-auto bg-gray-800 rounded-3xl shadow-4xl border border-indigo-500/50 p-8">
        <header class="text-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-4xl font-extrabold text-indigo-400 mb-2 tracking-tight">
                AI Price Negotiator ü§ñ
            </h1>
            <h2 class="text-2xl text-white font-medium">
                {{ product.name }} 
                <span class="text-green-400 ml-3">| Price: UGX {{ current_price|floatformat:0|intcomma }}</span>
            </h2>
            <p class="text-gray-400 text-sm mt-1">
                Chat with the bot to agree on a final price. **The AI will enforce fair price limits.**
            </p>
        </header>

        <div id="chat-window" class="h-[450px] overflow-y-auto p-4 space-y-4 mb-6 bg-gray-900 rounded-xl border border-gray-700 shadow-inner shadow-gray-950/70">
            {% for message in chat_history %}
                {% if message.role == 'user' %}
                    <div class="flex justify-end">
                        <div class="max-w-xs md:max-w-md bg-indigo-600 text-white p-3 rounded-2xl rounded-tr-sm shadow-xl transform transition-all duration-300 hover:scale-[1.01]">
                            <p class="text-sm">{{ message.text }}</p>
                        </div>
                    </div>
                {% else %}
                    <div class="flex justify-start">
                        <div class="flex items-start space-x-3">
                            <div class="p-2 bg-gray-700 rounded-full flex-shrink-0">
                                <span class="text-indigo-400 text-lg">
                                    {% if message.role == 'system' %}üõ°Ô∏è{% else %}ü§ñ{% endif %}
                                </span>
                            </div>
                            <div class="max-w-xs md:max-w-md bg-gray-700 text-gray-200 p-3 rounded-2xl rounded-tl-sm shadow-xl">
                                {% if message.role != 'system' %}
                                    <p class="text-sm font-semibold text-indigo-300 mb-1">AI Bot:</p>
                                {% endif %}
                                <p class="text-sm">{{ message.text|safe }}</p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <form method="post" class="flex space-x-3 p-2 bg-gray-700 rounded-xl shadow-inner">
            {% csrf_token %}
            {{ form.user_message|attr:"class:w-full px-4 py-3 bg-gray-900 text-gray-200 border-none rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-500 transition-colors duration-200"|attr:"placeholder:Enter your offer (e.g., 'UGX 100,000') or a message..." }}
            <button type="submit" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-colors duration-200 flex-shrink-0 shadow-lg hover:shadow-indigo-500/50">
                Send
            </button>
        </form>

        <div class="mt-8 text-center">
            <a href="{% url 'eshop:accept_negotiated_price' product.slug %}" 
               class="inline-block bg-green-600 hover:bg-green-700 text-white font-extrabold text-lg py-3.5 px-10 rounded-xl transition-all duration-300 shadow-2xl shadow-green-600/50 transform hover:scale-[1.04] ring-4 ring-green-600/30">
                Accept Final Price ü§ù
            </a>
            <p class="text-xs text-gray-500 mt-3">
                This will finalize the price and add the product to your cart with the agreed-upon amount.
            </p>
        </div>
    </div>
</div>

<script>
    // Scroll to the bottom of the chat window on load
    const chatWindow = document.getElementById('chat-window');
    chatWindow.scrollTop = chatWindow.scrollHeight;
</script>

{% endblock %}