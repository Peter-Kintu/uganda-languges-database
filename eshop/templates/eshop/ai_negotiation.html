{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load widget_tweaks %}

{% block title %}Negotiate Price for {{ product.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 md:py-12">
    {# Main Negotiation Card #}
    <div class="max-w-4xl mx-auto bg-gray-900 rounded-3xl shadow-2xl border border-indigo-500/30 overflow-hidden">
        
        {# Header Section #}
        <header class="bg-indigo-900/40 p-6 border-b border-indigo-500/20 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-extrabold text-white tracking-tight">
                    <span class="text-indigo-400">AI</span> Price Negotiator
                </h1>
                <p class="text-gray-400 text-sm">Bargaining for: <span class="text-indigo-300 font-semibold">{{ product.name }}</span></p>
            </div>
            <div class="bg-gray-800/80 px-4 py-2 rounded-2xl border border-green-500/40 text-center">
                <p class="text-[10px] uppercase font-bold text-gray-500 tracking-widest">Original Price</p>
                <p class="text-xl font-black text-green-400">{{ product.get_currency_code }} {{ product.price|floatformat:0|intcomma }}</p>
            </div>
        </header>

        <div class="p-4 md:p-8">
            {# Chat Window #}
            <div id="chat-window" 
                 class="h-[450px] lg:h-[550px] overflow-y-auto p-4 space-y-6 mb-6 bg-gray-950/50 rounded-2xl border-2 border-gray-800 shadow-inner custom-scrollbar">
                
                {# Initial Bot Greeting #}
                <div class="flex justify-start">
                    <div class="max-w-[85%] bg-gray-800 text-gray-200 p-4 rounded-2xl rounded-tl-none shadow-lg border border-gray-700">
                        <p class="text-xs font-bold text-indigo-400 mb-1">Ana (AI Assistant)</p>
                        <p class="text-sm md:text-base italic">"Hello! I'm here to help you get the best deal. What's your offer for the {{ product.name }}?"</p>
                    </div>
                </div>

                {% for message in chat_history %}
                    {% if message.role == 'user' %}
                        <div class="flex justify-end">
                            <div class="max-w-[85%] bg-indigo-600 text-white p-4 rounded-2xl rounded-tr-none shadow-xl transform transition hover:scale-[1.01]">
                                <p class="text-xs font-bold mb-1 opacity-70 text-right">You</p>
                                <p class="text-sm md:text-base leading-relaxed">{{ message.text|safe }}</p>
                            </div>
                        </div>
                    {% else %}
                        <div class="flex justify-start">
                            <div class="max-w-[85%] bg-gray-800 text-gray-200 p-4 rounded-2xl rounded-tl-none shadow-lg border border-gray-700 transform transition hover:scale-[1.01]">
                                <p class="text-xs font-bold text-indigo-400 mb-1">Ana</p>
                                <p class="text-sm md:text-base leading-relaxed">{{ message.text|safe }}</p>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
                
                <div id="typing-indicator" class="hidden flex justify-start">
                    <div class="bg-gray-800 p-3 rounded-xl animate-pulse text-gray-500 text-xs">Ana is thinking...</div>
                </div>
            </div>

            {# Input Form #}
            <form method="post" id="negotiation-form" class="relative">
                {% csrf_token %}
                <div class="flex flex-col sm:flex-row gap-3 bg-gray-800 p-2 rounded-2xl border border-gray-700 focus-within:border-indigo-500 transition-all shadow-2xl">
                    <div class="flex-grow">
                        {# We now use the classes defined in forms.py for stability #}
                        {{ form.user_message }}
                    </div>
                    <button type="submit" 
                            onclick="showTyping()"
                            class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg active:scale-95">
                        <span>Send Offer</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                        </svg>
                    </button>
                </div>
                <div class="mt-3 flex justify-between items-center px-2">
                    <p class="text-[10px] md:text-xs text-gray-500 italic">
                        English & African languages supported.
                    </p>
                    <a href="{% url 'eshop:product_detail' product.slug %}" class="text-[10px] md:text-xs text-indigo-400 hover:underline">
                        Cancel & Back to Product
                    </a>
                </div>
            </form>

            {# Success/Lock-in Action #}
            <div class="mt-10 pt-6 border-t border-gray-800">
                {% with final_price=product.negotiated_price|default:product.price %}
                <div class="flex flex-col items-center">
                    {% if is_negotiation_active %}
                        <div class="mb-4 px-4 py-2 bg-green-900/20 border border-green-500/30 rounded-full animate-bounce">
                            <span class="text-green-400 text-sm font-bold">‚ú® Great Deal Reached! ‚ú®</span>
                        </div>
                        <a href="{% url 'eshop:accept_negotiated_price' product.slug %}" 
                           class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-black text-xl py-5 px-12 rounded-2xl transition-all duration-300 shadow-2xl shadow-green-600/40 transform hover:scale-[1.03] ring-4 ring-green-600/20 text-center">
                            Accept {{ product.get_currency_code }} {{ final_price|floatformat:0|intcomma }} & Close Deal ü§ù
                        </a>
                    {% else %}
                        <div class="w-full bg-gray-800/50 p-6 rounded-2xl border border-gray-700 text-center opacity-60">
                            <p class="text-gray-400 font-medium text-sm sm:text-base">
                                The "Lock In" button will appear once the AI agrees to your price.
                            </p>
                        </div>
                    {% endif %}
                </div>
                {% endwith %}
            </div>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(31, 41, 55, 0.5); }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6366f1; }
</style>

<script>
    const chatWindow = document.getElementById('chat-window');
    
    function scrollToBottom() {
        if (chatWindow) {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    }

    function showTyping() {
        const input = document.querySelector('input[name="user_message"]');
        if (input && input.value.trim() !== "") {
            document.getElementById('typing-indicator').classList.remove('hidden');
            scrollToBottom();
        }
    }

    window.onload = scrollToBottom;

    const observer = new MutationObserver(scrollToBottom);
    if (chatWindow) {
        observer.observe(chatWindow, { childList: true });
    }
</script>
{% endblock %}