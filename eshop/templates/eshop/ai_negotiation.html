{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Negotiate Price for {{ product.name }}{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-12">
    <div class="max-w-3xl mx-auto bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 p-8">
        <header class="text-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-4xl font-extrabold text-indigo-400 mb-2 tracking-tight">
                AI Price Negotiator ü§ñ
            </h1>
            <h2 class="text-2xl text-white font-medium">
                {{ product.name }} 
                <span class="text-green-400 ml-3">| Price: UGX {{ current_price|floatformat:0|intcomma }}</span>
            </h2>
            <p class="text-gray-400 text-sm mt-1">
                Chat with the bot to agree on a final price.
            </p>
        </header>

        <div id="chat-window" class="h-[400px] overflow-y-auto p-4 space-y-4 mb-6 bg-gray-900 rounded-xl border border-gray-700">
            {% for message in chat_history %}
                {% if message.role == 'user' %}
                    <div class="flex justify-end">
                        <div class="max-w-xs md:max-w-md bg-indigo-600 text-white p-3 rounded-t-xl rounded-bl-xl shadow-lg">
                            <p class="text-sm">{{ message.text }}</p>
                        </div>
                    </div>
                {% else %}
                    <div class="flex justify-start">
                        <div class="max-w-xs md:max-w-md bg-gray-700 text-gray-200 p-3 rounded-t-xl rounded-br-xl shadow-lg">
                            <p class="text-sm font-semibold text-indigo-300 mb-1">AI Bot:</p>
                            <p class="text-sm">{{ message.text|safe }}</p>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <form method="post" class="flex space-x-3">
            {% csrf_token %}
            {{ form.user_message }}
            <button type="submit" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-colors duration-200 flex-shrink-0">
                Send
            </button>
        </form>

        <div class="mt-6 text-center">
            <a href="{% url 'eshop:accept_negotiated_price' product.slug %}" 
               class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 shadow-lg shadow-green-600/30 transform hover:scale-[1.02]">
                Accept Final Price ü§ù
            </a>
            <p class="text-xs text-gray-500 mt-2">
                Click this when you and the AI have agreed on a price.
            </p>
        </div>
    </div>
</div>

<script>
    // Scroll to the bottom of the chat window on load
    const chatWindow = document.getElementById('chat-window');
    chatWindow.scrollTop = chatWindow.scrollHeight;
</script>

{% endblock %}