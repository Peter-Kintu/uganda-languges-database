{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load widget_tweaks %}

{% block title %}Negotiate Price for {{ product.name }}{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-8 sm:py-12 lg:py-16">
    <!-- Reduced max-width for better mobile centering, kept padding responsive -->
    <div class="max-w-xl md:max-w-3xl mx-auto bg-gray-800 rounded-3xl shadow-4xl border border-indigo-500/50 p-6 sm:p-8">
        
        <!-- Responsive Header: scaled down text for small screens -->
        <header class="text-center mb-6 sm:mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-400 mb-1 sm:mb-2 tracking-tight">
                AI Price Negotiator ü§ñ
            </h1>
            <h2 class="text-xl sm:text-2xl text-white font-medium">
                {{ product.name }} 
                <!-- Price info breaks to new line on mobile for clean look -->
                <span class="text-green-400 ml-2 sm:ml-3 block sm:inline">| Price: UGX {{ current_price|floatformat:0|intcomma }}</span>
            </h2>
            <p class="text-gray-400 text-sm mt-1">
                Chat with the bot to agree on a final price. **The AI will enforce fair price limits.**
            </p>
        </header>

        <!-- Responsive Chat Window: dynamic height based on screen size -->
        <div id="chat-window" 
             class="h-[400px] sm:h-[450px] lg:h-[500px] overflow-y-auto p-4 space-y-4 mb-6 bg-gray-900 rounded-xl border border-gray-700">
            {% for message in chat_history %}
                {% if message.role == 'user' %}
                    <!-- User Message (Right Aligned) -->
                    <div class="flex justify-end">
                        <!-- max-w-[85%] ensures wrapping on small screens and padding on the left -->
                        <div class="max-w-[85%] bg-indigo-600 text-white p-3 rounded-t-xl rounded-bl-xl shadow-lg">
                            <p class="text-sm font-semibold mb-1">You:</p>
                            <p class="text-sm">{{ message.text|safe }}</p>
                        </div>
                    </div>
                {% else %}
                    <!-- AI Message (Left Aligned) -->
                    <div class="flex justify-start">
                        <!-- max-w-[85%] ensures wrapping on small screens and padding on the right -->
                        <div class="max-w-[85%] bg-gray-700 text-gray-200 p-3 rounded-t-xl rounded-br-xl shadow-lg">
                            <p class="text-sm font-semibold text-indigo-300 mb-1">AI Bot:</p>
                            <p class="text-sm">{{ message.text|safe }}</p>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Input Form -->
        <form method="post" class="flex space-x-3 p-2 bg-gray-700 rounded-xl shadow-inner">
            {% csrf_token %}
            {# The input field uses w-full for fluid width #}
            {{ form.user_message|attr:"class:w-full px-4 py-3 bg-gray-900 text-gray-200 border-none rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-500 transition-colors duration-200"|attr:"placeholder:Enter your offer (e.g., 'UGX 100,000') or a message..." }}
            <button type="submit" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 sm:px-6 rounded-xl transition-colors duration-200 flex-shrink-0 shadow-lg hover:shadow-indigo-500/50">
                Send
            </button>
        </form>

        <!-- Action Button: scaled button text and padding for small screens -->
        <div class="mt-6 sm:mt-8 text-center">
            <a href="{% url 'eshop:accept_negotiated_price' product.slug %}" 
               class="inline-block bg-green-600 hover:bg-green-700 text-white font-extrabold text-base sm:text-lg py-3.5 px-6 sm:px-10 rounded-xl transition-all duration-300 shadow-lg shadow-green-600/30 transform hover:scale-[1.02] ring-4 ring-green-600/30">
                Accept Final Price ü§ù
            </a>
            <p class="text-xs text-gray-500 mt-2">
                Click this when you and the AI have agreed on a price.
            </p>
        </div>
    </div>
</div>

<script>
    // Scroll chat window to the bottom on load
    window.onload = function() {
        const chatWindow = document.getElementById('chat-window');
        if (chatWindow) {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    };
</script>

{% endblock %}